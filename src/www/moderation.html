<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketNet</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/main.js"></script>
</head>

<body>
    <header class="head-box sticky-header">
        <div class="head-box-item head-box-subtitle"><a href="/nodes">Nodes</a></div>
        <div class="head-box-item head-box-title"><a href="/moderation">Moderation</a></div>
    </header>
    
    <main>
        <div class="post-header-box">
            <div id="statistics">
                <div id="stats-text"></div>
            </div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫.." oninput="filterJury()" class="search-field">
                <button onclick="clearSearch()" class="search-close">‚úñ</button>
            </div>
        </div>
        <table>
            <thead class="sticky-header sticky-header-table">
                <tr>
                    <th># <span class="sort-icon" id="sort-index"></span></th>
                    <th>ID <span class="sort-icon" id="sort-id"></span></th>
                    <th>–ê–¥—Ä–µ—Å <span class="sort-icon" id="sort-address"></span></th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞ <span class="sort-icon" id="sort-reason"></span></th>
                    <th>–í–µ—Ä–¥–∏–∫—Ç <span class="sort-icon" id="sort-verdict"></span></th>
                </tr>
            </thead>
            <tbody id="jury-list">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∂—é—Ä–∏ -->
            </tbody>
        </table>
        <div class="pagination">
            <button onclick="prevPage()" id="prev-page" disabled>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
            <button onclick="nextPage()" id="next-page">–°–ª–µ–¥—É—é—â–∞—è</button>
        </div>
    </main>

    <button class="theme-toggle" onclick="toggleTheme()">üåì –¢–µ–º–∞</button>
    <script>
        let juryList = []; // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∂—é—Ä–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let currentSortColumn = 0;
        let currentSortDirection = 'desc';
        let currentPage = 0; // –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ currentPage
        const itemsPerPage = 15;

        const reasonDictionary = {
            '1': '–≠—Ä–æ—Ç–∏–∫–∞/–ü–æ—Ä–Ω–æ',
            '2': '–î–µ—Ç—Å–∫–∞—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è',
            '3': '–ü—Ä—è–º–∞—è —É–≥—Ä–æ–∑–∞ –Ω–∞—Å–∏–ª–∏—è',
            '4': '–ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–µ –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏',
            '5': '–ù–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç—Ä–æ—Å–∫–∏—Ö –ø—Ä–∞–≤',
            '6': '–°–ø–∞–º'
        };

        const verdictDictionary = {
            '-1': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
            '0': '–û–ø—Ä–∞–≤–¥–∞–Ω',
            '1': '–û—Å—É–∂–¥–µ–Ω'
        };

        function updateSortIcons() {
            const icons = document.querySelectorAll('.sort-icon');
            icons.forEach(icon => icon.innerHTML = '');

            const currentColumn = currentSortColumn;
            const sortDirection = currentSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            if (currentColumn >= 0 && currentColumn < icons.length) {
                icons[currentColumn].innerHTML = sortDirection;
            }
        }

        function sortJury(columnIndex, changeDirection = true) {
            const columnKeys = ['index', 'id', 'address', 'reason', 'verdict'];
            const key = columnKeys[columnIndex];

            if (changeDirection) {
                if (currentSortColumn === columnIndex) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = columnIndex;
                    currentSortDirection = 'desc';
                }
            }

            juryList.sort((a, b) => {
                let aValue = a[key] || '';
                let bValue = b[key] || '';
                
                return currentSortDirection === 'asc' ? 
                    (aValue > bValue ? 1 : -1) : 
                    (aValue < bValue ? 1 : -1);
            });

            updateSortIcons();
        }

        function updateStatistics() {
            const statisticsDiv = document.getElementById('statistics');
            
            const totalJury = juryList.length;
            
            const reasonStats = {};
            
            juryList.forEach(jury => {
                if (!reasonStats[jury.reason]) {
                    reasonStats[jury.reason] = {
                        '-1': 0,
                        '0': 0,
                        '1': 0,
                        total: 0
                    };
                }
                reasonStats[jury.reason][jury.verdict]++;
                reasonStats[jury.reason].total++;
            });

            statisticsDiv.innerHTML = `
                <table class="version-table">
                    <tr>
                        <td>–ü—Ä–∏—á–∏–Ω–∞</td>
                        <td>–í—Å–µ–≥–æ</td>
                        <td>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</td>
                        <td>–û–ø—Ä–∞–≤–¥–∞–Ω</td>
                        <td>–û—Å—É–∂–¥–µ–Ω</td>
                    </tr>
                    ${Object.entries(reasonStats)
                        .map(([reason, stats]) => `
                            <tr>
                                <td>${reasonDictionary[reason] || reason}</td>
                                <td>${stats.total}</td>
                                <td>${stats['-1']}</td>
                                <td>${stats['0']}</td>
                                <td>${stats['1']}</td>
                            </tr>
                        `).join('')}
                    <tr>
                        <td><strong>–ò—Ç–æ–≥–æ</strong></td>
                        <td><strong>${totalJury}</strong></td>
                        <td><strong>${juryList.filter(j => j.verdict === '-1').length}</strong></td>
                        <td><strong>${juryList.filter(j => j.verdict === '0').length}</strong></td>
                        <td><strong>${juryList.filter(j => j.verdict === '1').length}</strong></td>
                    </tr>
                </table>
            `;
        }

        function renderJury() {
            const juryListElement = document.getElementById('jury-list');
            juryListElement.innerHTML = '';

            const searchValue = document.getElementById('search-input').value.toLowerCase();
            const filteredJury = juryList.filter(jury => {
                return Object.values(jury).some(value =>
                    String(value).toLowerCase().includes(searchValue)
                );
            });

            filteredJury.forEach((jury, index) => {
                const row = document.createElement('tr');
                const reasonText = reasonDictionary[jury.reason] || jury.reason;
                const verdictText = verdictDictionary[jury.verdict] || jury.verdict;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${jury.id}</td>
                    <td>${jury.address}</td>
                    <td>${reasonText}</td>
                    <td>${verdictText}</td>
                `;
                juryListElement.appendChild(row);
            });

            updateStatistics();
            updatePagination();
        }

        function updatePagination() {
            const pageInfo = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');

            pageInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage + 1}`;
            prevButton.disabled = currentPage === 0;
            nextButton.disabled = juryList.length < itemsPerPage;
        }

        async function fetchJury() {
            try {
                const response = await fetch(`/list_juries`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "page": currentPage,
                        "limit": itemsPerPage
                    })
                });
                
                const data = await response.json();
                
                if (data.items && Array.isArray(data.items)) {
                    retryCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
                    juryList = data.items.map(item => ({
                        index: item.height,
                        id: item.content_id,
                        address: item.address,
                        reason: item.reason,
                        verdict: item.verdict
                    }));
                    sortJury(currentSortColumn, false);
                    renderJury();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∂—é—Ä–∏:', error);
            }
        }

        function filterJury() {
            renderJury();
        }

        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.value = '';
            filterJury();
        }

        function nextPage() {
            currentPage++;
            fetchJury();
            updatePagination();
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                fetchJury();
                updatePagination();
            }
        }

        window.onload = () => {
            fetchJury();
            setInterval(fetchJury, 30000);

            document.querySelectorAll('th').forEach((th, index) => {
                th.addEventListener('click', () => {
                    sortJury(index);
                    renderJury();
                });
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        };
    </script>

    <footer style="
        margin-top: 20px;
        padding: 20px;
        text-align: center;
        color: var(--text-color);
    ">
        <p>
            ¬© <script>document.write(new Date().getFullYear())</script> PocketNET Team.
            <a href="https://www.apache.org/licenses/LICENSE-2.0" style="color: var(--text-color);">
                Licensed under the Apache License, Version 2.0
            </a>
        </p>
        <p>
            <a href="https://bastyon.com" style="color: var(--text-color); margin-right: 20px;">Bastyon</a>
            <a href="https://bastyon.com/blockexplorer" style="color: var(--text-color);">Block Explorer</a>
        </p>
    </footer>
</body>

</html>