<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PocketNet</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>
    <header class="head-box sticky-header">
        <div class="head-box-item head-box-title">‚ãÆ</div>
        <div class="head-box-item head-box-subtitle"><a href="/nodes">Nodes</a></div>
        <div class="head-box-item head-box-title"><a href="/moderation">Moderation</a></div>
    </header>
    
    <main>
        <div class="post-header-box">
            <div id="statistics">
                <div id="stats-text"></div>
            </div>
            <div class="filter-box" style="margin: 15px 0;">
                <label style="margin-right: 15px;">
                    <input type="radio" name="verdict-filter" value="-2" checked> –í—Å–µ
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="verdict-filter" value="-1"> –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="verdict-filter" value="0"> –û–ø—Ä–∞–≤–¥–∞–Ω
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="verdict-filter" value="1"> –û—Å—É–∂–¥–µ–Ω
                </label>
            </div>
        </div>
        <table>
            <thead class="sticky-header sticky-header-table">
                <tr>
                    <th>#</th>
                    <th>ID</th>
                    <th>–ê–¥—Ä–µ—Å</th>
                    <th>–í—ã—Å–æ—Ç–∞</th>
                    <th>–¢–∏–ø</th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                    <th>–í–µ—Ä–¥–∏–∫—Ç</th>
                    <th>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</th>
                </tr>
            </thead>
            <tbody id="jury-list">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∂—é—Ä–∏ -->
            </tbody>
        </table>
        <div class="pagination" id="pagination">
            <!-- –ö–Ω–æ–ø–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            <select id="itemsPerPageSelect" style="margin-left: 15px; visibility: hidden;">
                <option value="15">15 —Å—Ç—Ä–æ–∫</option>
                <option value="30">30 —Å—Ç—Ä–æ–∫</option>
                <option value="50">50 —Å—Ç—Ä–æ–∫</option>
                <option value="100">100 —Å—Ç—Ä–æ–∫</option>
            </select>
        </div>
    </main>

    <button class="theme-toggle" onclick="toggleTheme()">üåì –¢–µ–º–∞</button>
    
    <footer style="
        margin-top: 20px;
        padding: 20px;
        text-align: center;
        color: var(--text-color);
    ">
        <p>
            ¬© <script>document.write(new Date().getFullYear())</script> PocketNET Team.
            <a href="https://www.apache.org/licenses/LICENSE-2.0" style="color: var(--text-color);">
                Licensed under the Apache License, Version 2.0
            </a>
        </p>
        <p>
            <a href="https://bastyon.com" style="color: var(--text-color); margin-right: 20px;">Bastyon</a>
            <a href="https://bastyon.com/blockexplorer" style="color: var(--text-color);">Block Explorer</a>
        </p>
    </footer>

    <!-- –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="moderatorsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>–°–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</h2>
            <div id="moderatorsList">
                <div class="spinner" style="display: none;">
                    <div class="spinner-inner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let juryList = {};
        let currentPage = 0;
        let itemsPerPage = parseInt(localStorage.getItem('itemsPerPage')) || 15;
        let currentFilter = '-2';

        const reasonDictionary = {
            '1': '–≠—Ä–æ—Ç–∏–∫–∞/–ü–æ—Ä–Ω–æ',
            '2': '–î–µ—Ç—Å–∫–∞—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è',
            '3': '–ü—Ä—è–º–∞—è —É–≥—Ä–æ–∑–∞ –Ω–∞—Å–∏–ª–∏—è',
            '4': '–ù–µ–ª–µ–≥–∞–ª—å–Ω—ã–µ –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏',
            '5': '–ù–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç—Ä–æ—Å–∫–∏—Ö –ø—Ä–∞–≤',
            '6': '–°–ø–∞–º'
        };

        const contentTypeDictionary = {
            '100': '–ê–∫–∫–∞—É–Ω—Ç',
            '200': '–ü–æ—Å—Ç',
            '201': '–í–∏–¥–µ–æ',
            '202': '–°—Ç–∞—Ç—å—è',
            '209': '–°—Ç—Ä–∏–º',
            '210': '–ê—É–¥–∏–æ',
            '220': '–ö–æ–ª–ª–µ–∫—Ü–∏—è',
            '221': '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
            '204': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'
        };

        const verdictDictionary = {
            '-1': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
            '0': '–û–ø—Ä–∞–≤–¥–∞–Ω',
            '1': '–û—Å—É–∂–¥–µ–Ω'
        };
        
        function renderJury() {
            const juryListElement = document.getElementById('jury-list');
            juryListElement.innerHTML = '';

            juryList.items.forEach((jury, index) => {
                const row = document.createElement('tr');
                const reasonText = reasonDictionary[jury.reason] || jury.reason;
                const verdictText = verdictDictionary[jury.verdict] || jury.verdict;
                const globalIndex = currentPage * itemsPerPage + index + 1;
                
                // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É ID —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                const idCell = `<a class="link" href="https://bastyon.com/jury?i=${jury.id}" target="_blank">${jury.id}</a>`;
                const addressCell = `<a class="link" href="https://bastyon.com/${jury.address}" target="_blank">${jury.address}</a>`;
                    
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>${idCell}</td>
                    <td>${addressCell}</td>
                    <td>${jury.height}</td>
                    <td>${contentTypeDictionary[jury.content_type] || jury.content_type}</td>
                    <td>${reasonText}</td>
                    <td>${verdictText}</td>
                    <td class="moderators-cell" onclick="showModerators('${jury.id}')">
                        <button>
                            üë•
                        </button>
                    </td>
                `;
                juryListElement.appendChild(row);
            });

            updatePagination();
        }

        function updatePagination() {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            const totalPages = Math.ceil(juryList.total / itemsPerPage);
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ñ—Ä –≤ –æ–±—â–µ–º —á–∏—Å–ª–µ —Å—Ç—Ä–∞–Ω–∏—Ü
            const totalDigits = totalPages.toString().length;
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏
            const formattedCurrentPage = (currentPage + 1).toString().padStart(totalDigits, '0');

            // –ö–Ω–æ–ø–∫–∞ –≤ –Ω–∞—á–∞–ª–æ "<<"
            const firstPageButton = document.createElement('button');
            firstPageButton.textContent = '<<';
            firstPageButton.disabled = currentPage === 0;
            firstPageButton.onclick = () => {
                currentPage = 0;
                fetchJury();
            };
            paginationElement.appendChild(firstPageButton);

            // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ "<"
            const prevPageButton = document.createElement('button');
            prevPageButton.textContent = '<';
            prevPageButton.disabled = currentPage === 0;
            prevPageButton.onclick = () => {
                currentPage = Math.max(0, currentPage - 1);
                fetchJury();
            };
            paginationElement.appendChild(prevPageButton);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const pageInfo = document.createElement('span');
            pageInfo.textContent = ` ${formattedCurrentPage} –∏–∑ ${totalPages} `;
            pageInfo.style.margin = '0 10px';
            paginationElement.appendChild(pageInfo);

            // –ö–Ω–æ–ø–∫–∞ –≤–ø–µ—Ä–µ–¥ ">"
            const nextPageButton = document.createElement('button');
            nextPageButton.textContent = '>';
            nextPageButton.disabled = currentPage >= totalPages - 1;
            nextPageButton.onclick = () => {
                currentPage = Math.min(totalPages - 1, currentPage + 1);
                fetchJury();
            };
            paginationElement.appendChild(nextPageButton);

            // –ö–Ω–æ–ø–∫–∞ –≤ –∫–æ–Ω–µ—Ü ">>"
            const lastPageButton = document.createElement('button');
            lastPageButton.textContent = '>>';
            lastPageButton.disabled = currentPage >= totalPages - 1;
            lastPageButton.onclick = () => {
                currentPage = totalPages - 1;
                fetchJury();
            };
            paginationElement.appendChild(lastPageButton);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ select
            const itemsPerPageSelect = document.createElement('select');
            itemsPerPageSelect.id = 'itemsPerPageSelect';
            itemsPerPageSelect.style.marginLeft = '15px';
            itemsPerPageSelect.style.visibility = 'hidden';
            [15, 30, 50, 100].forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = `${value} —Å—Ç—Ä–æ–∫`;
                option.selected = value === itemsPerPage;
                itemsPerPageSelect.appendChild(option);
            });
            
            itemsPerPageSelect.onchange = (e) => {
                itemsPerPage = parseInt(e.target.value);
                localStorage.setItem('itemsPerPage', itemsPerPage);
                currentPage = 0;
                fetchJury();
            };
            
            paginationElement.appendChild(itemsPerPageSelect);
        }

        async function fetchJury() {
            try {
                const response = await fetch(`/list_juries`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "page": currentPage,
                        "limit": itemsPerPage,
                        "verdict": parseInt(currentFilter)
                    })
                });
                
                juryList = await response.json();
                renderJury();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∂—é—Ä–∏:', error);
            }
        }

        function window_onload() {
            document.querySelectorAll('input[name="verdict-filter"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentFilter = e.target.value;
                    currentPage = 0;
                    fetchJury();
                });
            });

            fetchJury();
            setInterval(fetchJury, 30000);
        };

        async function showModerators(juryId) {
            document.getElementById('moderatorsModal').style.display = 'block';
            const moderatorsListElement = document.getElementById('moderatorsList');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            moderatorsListElement.innerHTML = `
                <div class="spinner" style="display: flex;">
                    <div class="spinner-inner"></div>
                </div>
            `;

            try {
                const response = await fetch(`/jury_moderators/${juryId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤');
                }
                
                const moderators = await response.json();
                
                if (moderators.length === 0) {
                    moderatorsListElement.innerHTML = '<p>–ù–µ—Ç –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</p>';
                } else {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤: —Å–Ω–∞—á–∞–ª–∞ –≥–æ–ª–æ—Å "–∑–∞" (1), –ø–æ—Ç–æ–º "–ø—Ä–æ—Ç–∏–≤" (0), –∑–∞—Ç–µ–º –±–µ–∑ –≥–æ–ª–æ—Å–∞ (-1)
                    const sortedModerators = [...moderators].sort((a, b) => {
                        const voteA = typeof a === 'object' && 'vote' in a ? a.vote : -1;
                        const voteB = typeof b === 'object' && 'vote' in b ? b.vote : -1;
                        return voteB - voteA;
                    });

                    moderatorsListElement.innerHTML = `
                        <table style="width: 100%;">
                            <thead class="sticky-header">
                                <tr>
                                    <th>–ê–¥—Ä–µ—Å</th>
                                    <th style="text-align: center;">–ì–æ–ª–æ—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedModerators.map(moderator => {
                                    const address = typeof moderator === 'string' ? moderator : moderator.address;
                                    const vote = typeof moderator === 'object' && 'vote' in moderator ? 
                                        moderator.vote === 1 ? '‚úì' : 
                                        moderator.vote === 0 ? '‚úó' : 
                                        '-' : '-';
                                    const voteColor = moderator.vote === 1 ? 'vote-green' : moderator.vote === 0 ? 'vote-red' : 'vote-gray';
                                    
                                    return `
                                        <tr>
                                            <td><a class="link" href="https://bastyon.com/${address}" target="_blank">${address}</a></td>
                                            <td class="moderators-vote ${voteColor}">${vote}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤:', error);
            }
        }

        function closeModal() {
            document.getElementById('moderatorsModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('moderatorsModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>

    <script src="/js/main.js"></script>
</body>

</html>